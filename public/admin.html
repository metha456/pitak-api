<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:sans-serif;background:#1a1a2e;color:#eee;min-height:100vh}
        .header{background:linear-gradient(135deg,#4A0012,#800020);padding:20px;text-align:center;border-bottom:3px solid #D4AF37}
        .header h1{color:#D4AF37;font-size:20px}
        .container{max-width:900px;margin:0 auto;padding:15px}
        .login-box{background:#252540;padding:30px;border-radius:12px;max-width:400px;margin:50px auto}
        .login-box h2{color:#D4AF37;margin-bottom:20px;text-align:center}
        .login-box input{width:100%;padding:12px;margin-bottom:15px;border:2px solid #444;border-radius:8px;background:#1a1a2e;color:#fff}
        .login-box button{width:100%;padding:14px;background:#D4AF37;border:none;border-radius:8px;color:#1a1a2e;font-weight:700;font-size:16px;cursor:pointer}
        .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:20px}
        .stat{background:#252540;padding:15px;border-radius:10px;text-align:center}
        .stat-num{font-size:28px;font-weight:700;color:#D4AF37}
        .stat-label{font-size:12px;color:#aaa;margin-top:5px}
        .filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .filters button{padding:8px 16px;border:2px solid #444;border-radius:20px;background:transparent;color:#fff;cursor:pointer}
        .filters button.active{border-color:#D4AF37;background:#D4AF37;color:#1a1a2e}
        .order-card{background:#252540;border-radius:12px;padding:15px;margin-bottom:12px;border-left:4px solid #D4AF37}
        .order-card.pending{border-left-color:#f39c12}
        .order-card.paid{border-left-color:#27ae60}
        .order-card.shipped{border-left-color:#3498db}
        .order-card.cancelled{border-left-color:#e74c3c}
        .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .order-id{font-weight:700;color:#D4AF37}
        .order-status{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
        .status-pending{background:#f39c12;color:#000}
        .status-paid{background:#27ae60;color:#fff}
        .status-shipped{background:#3498db;color:#fff}
        .status-completed{background:#9b59b6;color:#fff}
        .status-cancelled{background:#e74c3c;color:#fff}
        .order-info{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;color:#ccc}
        .order-info span{display:block}
        .order-info strong{color:#fff}
        .order-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
        .order-actions button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600}
        .btn-paid{background:#27ae60;color:#fff}
        .btn-shipped{background:#3498db;color:#fff}
        .btn-cancel{background:#e74c3c;color:#fff}
        .loading{text-align:center;padding:40px;color:#888}
        .slip-link{color:#D4AF37;text-decoration:underline}
        .no-orders{text-align:center;padding:40px;color:#666}
        .refresh-btn{background:#444;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;margin-bottom:15px}
        .logout-btn{position:absolute;right:20px;top:20px;background:transparent;border:1px solid #D4AF37;color:#D4AF37;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px}
    </style>
</head>
<body>

<div class="header" style="position:relative">
    <h1>üõ°Ô∏è Admin Dashboard</h1>
    <p style="color:#F4E4BA;font-size:12px;margin-top:5px">‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô</p>
    <button class="logout-btn" onclick="logout()" id="logoutBtn" style="display:none">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<div class="container">
    <!-- Login -->
    <div id="loginBox" class="login-box">
        <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
        <input type="password" id="adminKey" placeholder="Admin Key">
        <button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <p id="loginError" style="color:#e74c3c;margin-top:10px;text-align:center;display:none">Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display:none">
        <button class="refresh-btn" onclick="loadOrders()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>

        <div class="summary" id="summary"></div>

        <div class="filters" id="filters">
            <button class="active" data-status="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button data-status="pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</button>
            <button data-status="paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>
            <button data-status="shipped">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
            <button data-status="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>

        <div id="orders"></div>
    </div>
</div>

<script>
const API = 'https://pitak-api.onrender.com';
let adminKey = '';
let allOrders = [];
let currentFilter = 'all';

function login() {
    adminKey = document.getElementById('adminKey').value;
    if (!adminKey) return;
    
    loadOrders().then(success => {
        if (success) {
            localStorage.setItem('adminKey', adminKey);
            document.getElementById('loginBox').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    });
}

function logout() {
    localStorage.removeItem('adminKey');
    adminKey = '';
    document.getElementById('loginBox').style.display = 'block';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('adminKey').value = '';
}

async function loadOrders() {
    try {
        const res = await fetch(`${API}/api/orders`, {
            headers: { 'X-Admin-Key': adminKey }
        });
        
        if (!res.ok) return false;
        
        const data = await res.json();
        if (!data.success) return false;
        
        allOrders = data.data.orders || [];
        renderSummary();
        renderOrders();
        return true;
    } catch (e) {
        console.error(e);
        return false;
    }
}

function renderSummary() {
    const summary = {
        total: allOrders.length,
        pending: allOrders.filter(o => o.status === 'pending').length,
        paid: allOrders.filter(o => o.status === 'paid').length,
        shipped: allOrders.filter(o => o.status === 'shipped').length,
        cancelled: allOrders.filter(o => o.status === 'cancelled').length
    };
    
    const totalAmount = allOrders.filter(o => o.status !== 'cancelled').reduce((sum, o) => sum + (o.total || 0), 0);
    
    document.getElementById('summary').innerHTML = `
        <div class="stat"><div class="stat-num">${summary.total}</div><div class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
        <div class="stat"><div class="stat-num" style="color:#f39c12">${summary.pending}</div><div class="stat-label">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</div></div>
        <div class="stat"><div class="stat-num" style="color:#27ae60">${summary.paid}</div><div class="stat-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div></div>
        <div class="stat"><div class="stat-num" style="color:#3498db">${summary.shipped}</div><div class="stat-label">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</div></div>
        <div class="stat"><div class="stat-num" style="color:#D4AF37">${totalAmount.toLocaleString()}</div><div class="stat-label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</div></div>
    `;
}

function renderOrders() {
    const filtered = currentFilter === 'all' ? allOrders : allOrders.filter(o => o.status === currentFilter);
    
    if (filtered.length === 0) {
        document.getElementById('orders').innerHTML = '<div class="no-orders">‡πÑ‡∏°‡πà‡∏°‡∏µ Orders</div>';
        return;
    }
    
    document.getElementById('orders').innerHTML = filtered.map(order => `
        <div class="order-card ${order.status}">
            <div class="order-header">
                <span class="order-id">${order.orderId}</span>
                <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
            </div>
            <div class="order-info">
                <span><strong>üë§</strong> ${order.customerName}</span>
                <span><strong>üìû</strong> ${order.phone}</span>
                <span><strong>üéñÔ∏è</strong> ${order.amuletName}</span>
                <span><strong>üì¶</strong> ${order.quantity} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                <span><strong>üí∞</strong> ${(order.total || 0).toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
                ${order.slipUrl ? `<span><a href="${order.slipUrl}" target="_blank" class="slip-link">üì∏ ‡∏î‡∏π‡∏™‡∏•‡∏¥‡∏õ</a></span>` : '<span style="color:#888">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</span>'}
            </div>
            <div class="order-actions">
                ${order.status === 'pending' ? `<button class="btn-paid" onclick="updateStatus('${order.orderId}','paid')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</button>` : ''}
                ${order.status === 'paid' ? `<button class="btn-shipped" onclick="updateStatus('${order.orderId}','shipped')">üöö ‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>` : ''}
                ${order.status === 'pending' ? `<button class="btn-cancel" onclick="updateStatus('${order.orderId}','cancelled')">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
            </div>
        </div>
    `).join('');
}

function getStatusText(status) {
    const map = { pending: '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞', paid: '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', shipped: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', completed: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', cancelled: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' };
    return map[status] || status;
}

async function updateStatus(orderId, status) {
    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "${getStatusText(status)}"?`)) return;
    
    try {
        const res = await fetch(`${API}/api/orders/${orderId}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'X-Admin-Key': adminKey },
            body: JSON.stringify({ status })
        });
        
        if (res.ok) {
            loadOrders();
        } else {
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
    } catch (e) {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
    }
}

// Filter buttons
document.getElementById('filters').addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        document.querySelectorAll('.filters button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.status;
        renderOrders();
    }
});

// Auto login
const savedKey = localStorage.getItem('adminKey');
if (savedKey) {
    adminKey = savedKey;
    document.getElementById('adminKey').value = savedKey;
    login();
}
</script>
</body>
</html>
